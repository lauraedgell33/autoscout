name: Deploy Backend to Forge

on:
  push:
    branches:
      - main
    paths:
      - 'scout-safe-pay-backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Laravel Forge
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.FORGE_SSH_KEY }}

      - name: Add Forge to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 146.190.185.209 >> ~/.ssh/known_hosts

      - name: Find and clean untracked files
        run: |
          ssh forge@146.190.185.209 'cd default && pwd && ls -la && git status || echo "Not a git repo, trying adminautoscout.dev..." && cd adminautoscout.dev && pwd && git status'

      - name: Deploy to Forge
        run: |
          ssh forge@146.190.185.209 'bash /home/forge/adminautoscout.dev/.deployment'

      - name: Verify Deployment
        run: |
          echo "Testing API endpoint..."
          curl -f https://adminautoscout.dev/api/dealers || exit 1
          echo "‚úÖ Backend deployment successful!"

      - name: Notify on Success
        if: success()
        run: echo "üéâ Backend deployed successfully to https://adminautoscout.dev"

      - name: Notify on Failure
        if: failure()
        run: echo "‚ùå Backend deployment failed!"
