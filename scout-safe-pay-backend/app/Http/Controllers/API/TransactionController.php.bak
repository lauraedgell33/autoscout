<?php

namespace App\Http\Controllers\API;

use App\Http\Controllers\Controller;
use App\Models\Transaction;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class TransactionController extends Controller
{
    /**
     * Display a listing of transactions
     */
    public function index(Request $request)
    {
        $user = $request->user();
        
        $query = Transaction::with(['buyer', 'seller', 'vehicle', 'dealer'])
            ->where(function($q) use ($user) {
                $q->where('buyer_id', $user->id)
                  ->orWhere('seller_id', $user->id);
                  
                if ($user->dealer_id) {
                    $q->orWhere('dealer_id', $user->dealer_id);
                }
            });

        $transactions = $query->latest()->paginate(15);

        return response()->json($transactions);
    }

    /**
     * Store a newly created transaction
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'vehicle_id' => 'required|exists:vehicles,id',
            'seller_id' => 'required|exists:users,id',
            'amount' => 'required|numeric|min:0',
        ]);

        $user = $request->user();
        
        // Calculate fees
        $serviceFee = max($validated['amount'] * 0.025, 25); // 2.5% or â‚¬25 minimum
        
        $transaction = Transaction::create([
            'buyer_id' => $user->id,
            'seller_id' => $validated['seller_id'],
            'vehicle_id' => $validated['vehicle_id'],
            'amount' => $validated['amount'],
            'service_fee' => $serviceFee,
            'escrow_account_iban' => config('escrow.accounts.DE.iban', 'DE89370400440532013000'),
            'escrow_account_country' => 'DE',
            'status' => 'awaiting_payment',
        ]);

        return response()->json([
            'message' => 'Transaction created successfully',
            'transaction' => $transaction->load(['buyer', 'seller', 'vehicle']),
        ], 201);
    }

    /**
     * Display the specified transaction
     */
    public function show(Request $request, Transaction $transaction)
    {
        $user = $request->user();
        
        // Check authorization
        if ($transaction->buyer_id !== $user->id && 
            $transaction->seller_id !== $user->id &&
            $transaction->dealer_id !== $user->dealer_id) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        return response()->json([
            'transaction' => $transaction->load([
                'buyer', 'seller', 'vehicle', 'dealer',
                'payments', 'documents', 'messages'
            ]),
        ]);
    }

    /**
     * Upload payment proof
     */
    public function uploadProof(Request $request, Transaction $transaction)
    {
        $request->validate([
            'proof' => 'required|file|mimes:pdf,jpg,jpeg,png|max:10240', // 10MB
        ]);

        $user = $request->user();
        
        if ($transaction->buyer_id !== $user->id) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        $path = $request->file('proof')->store('payment-proofs', 'public');

        $transaction->update([
            'payment_proof_url' => $path,
            'payment_proof_type' => $request->file('proof')->extension(),
            'payment_proof_uploaded_at' => now(),
            'status' => 'payment_submitted',
        ]);

        return response()->json([
            'message' => 'Payment proof uploaded successfully',
            'transaction' => $transaction,
        ]);
    }

    /**
     * Update transaction status
     */
    public function update(Request $request, Transaction $transaction)
    {
        $validated = $request->validate([
            'status' => 'required|in:cancelled,inspection_passed,inspection_failed',
        ]);

        $user = $request->user();
        
        // Authorization check
        if ($transaction->buyer_id !== $user->id) {
            return response()->json(['message' => 'Unauthorized'], 403);
        }

        $transaction->update($validated);

        return response()->json([
            'message' => 'Transaction updated successfully',
            'transaction' => $transaction,
        ]);
    }

    /**
     * Cancel transaction
     */
    public function destroy(Transaction $transaction)
    {
        if ($transaction->status !== 'pending' && $transaction->status !== 'awaiting_payment') {
            return response()->json([
                'message' => 'Cannot cancel transaction in current status',
            ], 400);
        }

        $transaction->update([
            'status' => 'cancelled',
            'cancelled_at' => now(),
        ]);

        return response()->json([
            'message' => 'Transaction cancelled successfully',
        ]);
    }
}
